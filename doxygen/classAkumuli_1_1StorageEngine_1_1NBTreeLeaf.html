<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Akumuli: Akumuli::StorageEngine::NBTreeLeaf Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Akumuli
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespaceAkumuli.html">Akumuli</a></li><li class="navelem"><b>StorageEngine</b></li><li class="navelem"><a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTreeLeaf.html">NBTreeLeaf</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-types">Public Types</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="classAkumuli_1_1StorageEngine_1_1NBTreeLeaf-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">Akumuli::StorageEngine::NBTreeLeaf Class Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="nbtree_8h_source.html">nbtree.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-types"></a>
Public Types</h2></td></tr>
<tr class="memitem:acfb048b63e674851ebef2d97ec7aa013"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><b>LeafLoadMethod</b> { <b>FULL_PAGE_LOAD</b>, 
<b>ONLY_HEADER</b>
 }</td></tr>
<tr class="separator:acfb048b63e674851ebef2d97ec7aa013"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:ae25c16551516d3ea633d5753f9bcf010"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTreeLeaf.html#ae25c16551516d3ea633d5753f9bcf010">NBTreeLeaf</a> (aku_ParamId id, LogicAddr prev)</td></tr>
<tr class="separator:ae25c16551516d3ea633d5753f9bcf010"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a730faf0d688bff85a96073e86d041eeb"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTreeLeaf.html#a730faf0d688bff85a96073e86d041eeb">NBTreeLeaf</a> (std::shared_ptr&lt; <a class="el" href="classAkumuli_1_1StorageEngine_1_1BlockStore.html">BlockStore</a> &gt; bstore, LogicAddr curr, LeafLoadMethod load=LeafLoadMethod::FULL_PAGE_LOAD)</td></tr>
<tr class="separator:a730faf0d688bff85a96073e86d041eeb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7efb009f826fde46eecd183276b2821a"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a7efb009f826fde46eecd183276b2821a"></a>
size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTreeLeaf.html#a7efb009f826fde46eecd183276b2821a">nelements</a> ()</td></tr>
<tr class="memdesc:a7efb009f826fde46eecd183276b2821a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Returns number of elements. <br/></td></tr>
<tr class="separator:a7efb009f826fde46eecd183276b2821a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa9a52a31d3fb4f8de13910f42fe58194"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aa9a52a31d3fb4f8de13910f42fe58194"></a>
std::tuple&lt; aku_Timestamp, <br class="typebreak"/>
aku_Timestamp &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTreeLeaf.html#aa9a52a31d3fb4f8de13910f42fe58194">get_timestamps</a> () const </td></tr>
<tr class="memdesc:aa9a52a31d3fb4f8de13910f42fe58194"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read timestamps. <br/></td></tr>
<tr class="separator:aa9a52a31d3fb4f8de13910f42fe58194"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae503a783fc0e6960fe4fdb492a80028a"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae503a783fc0e6960fe4fdb492a80028a"></a>
LogicAddr&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTreeLeaf.html#ae503a783fc0e6960fe4fdb492a80028a">get_prev_addr</a> () const </td></tr>
<tr class="memdesc:ae503a783fc0e6960fe4fdb492a80028a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get logic address of the previous node. <br/></td></tr>
<tr class="separator:ae503a783fc0e6960fe4fdb492a80028a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a40701c4015765a5c0c7bfeedcda4badd"><td class="memItemLeft" align="right" valign="top">aku_Status&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTreeLeaf.html#a40701c4015765a5c0c7bfeedcda4badd">read_all</a> (std::vector&lt; aku_Timestamp &gt; *timestamps, std::vector&lt; double &gt; *values)</td></tr>
<tr class="separator:a40701c4015765a5c0c7bfeedcda4badd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af8b25ed9aea04f8c47ede5f5d20a9801"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="af8b25ed9aea04f8c47ede5f5d20a9801"></a>
aku_Status&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTreeLeaf.html#af8b25ed9aea04f8c47ede5f5d20a9801">append</a> (aku_Timestamp ts, double value)</td></tr>
<tr class="memdesc:af8b25ed9aea04f8c47ede5f5d20a9801"><td class="mdescLeft">&#160;</td><td class="mdescRight">Append values to <a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTree.html">NBTree</a>. <br/></td></tr>
<tr class="separator:af8b25ed9aea04f8c47ede5f5d20a9801"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad69a5459fad4abfa2a29c2c9e59bd17e"><td class="memItemLeft" align="right" valign="top">std::tuple&lt; aku_Status, LogicAddr &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTreeLeaf.html#ad69a5459fad4abfa2a29c2c9e59bd17e">commit</a> (std::shared_ptr&lt; <a class="el" href="classAkumuli_1_1StorageEngine_1_1BlockStore.html">BlockStore</a> &gt; bstore)</td></tr>
<tr class="separator:ad69a5459fad4abfa2a29c2c9e59bd17e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Necklace B-tree data-structure implementation. Outline:</p>
<pre class="fragment">                                              [superblock0]
                                                    |
         +------------------------------+---....----+----~
         |                              |
         v                              v
   [superblock0]&lt;-----------------[superblock1]&lt;--....
         |                              |
+--------+---------+          +---------+---------+
|        |         |          |         |         |
v        v         v          v         v         v
</pre><p> [leaaf0]&lt;&ndash;[....]&lt;&ndash;[leafK] [leafK+1]&lt;&ndash;[....]&lt;&ndash;[leaf2K]</p>
<p>K is a fan-out range (<a class="el" href="namespaceAkumuli.html">Akumuli</a> uses K=64).</p>
<p><a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTree.html">NBTree</a> don't have one single root. Instead of that tree height is limited and nodes on one level are linked in backward direction (new node has pointer to previous). Useful data stored only in leaf nodes.</p>
<p>Leaf nodes and superblocks from one subtree don't have links to previous subtree. They can be connected only through upper level superblock that have links to all existing subtrees.</p>
<p>Important property: superblock at level N are linked directly (using links to underlying nodes only) to K^N nodes. All nodes a of the same size and all such subtrees are full trees so space taken by each subtree are the same (but there could be some internal fragmentation though). In this implementation nodes are stored in underlying block store. In this block store old pages can be deleted to reclaim space. This process shouldn't corrupt <a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTree.html">NBTree</a> because only last node from each hierarchy level is needed to traverse and append new data.</p>
<p>Append.</p>
<ul>
<li>Append data to the current leaf block in main-memory.</li>
<li>If block becomes full - write it to block-store. Add pointer to previous leaf node to the current leaf node.</li>
<li>Add link to newly saved block to the current superblock on level 1.</li>
<li>If superblock on level 1 become full - write it to block-store. Add pointer to previous superblock on level 1.</li>
<li>Add link to newly saved block to the current superblock on level 2, etc.</li>
</ul>
<p>Application should store somewhere root of the <a class="el" href="classAkumuli_1_1StorageEngine_1_1NBTree.html">NBTree</a> (the rightmost superblock in the top layer) and links to all nonfinished subtrees (these subtrees shouldn't be connected to top superblock).</p>
<p>Application should maintain metadata inside each superblock. Each node link should contain the following information about pointee: version, tree level, number of elements in the subtree, series id, smallest/largest timestamp of the subtree, address of the node, smallest/largest value of the subtree, sum of the elements of the subtree. This information can be used to speedup some aggregation queries, like count(), avg(), sum() etc.NBTree leaf node. Supports append operation. Can be commited to block store when full. </p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="ae25c16551516d3ea633d5753f9bcf010"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Akumuli::StorageEngine::NBTreeLeaf::NBTreeLeaf </td>
          <td>(</td>
          <td class="paramtype">aku_ParamId&#160;</td>
          <td class="paramname"><em>id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">LogicAddr&#160;</td>
          <td class="paramname"><em>prev</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Create empty leaf node. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">id</td><td>Series id. </td></tr>
    <tr><td class="paramname">link</td><td>to block store. </td></tr>
    <tr><td class="paramname">prev</td><td>Prev element of the tree. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a730faf0d688bff85a96073e86d041eeb"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Akumuli::StorageEngine::NBTreeLeaf::NBTreeLeaf </td>
          <td>(</td>
          <td class="paramtype">std::shared_ptr&lt; <a class="el" href="classAkumuli_1_1StorageEngine_1_1BlockStore.html">BlockStore</a> &gt;&#160;</td>
          <td class="paramname"><em>bstore</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">LogicAddr&#160;</td>
          <td class="paramname"><em>curr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">LeafLoadMethod&#160;</td>
          <td class="paramname"><em>load</em> = <code>LeafLoadMethod::FULL_PAGE_LOAD</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Load from block store. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">bstore</td><td><a class="el" href="classAkumuli_1_1StorageEngine_1_1Block.html" title="Represents memory block. ">Block</a> store. </td></tr>
    <tr><td class="paramname">curr</td><td>Address of the current leaf-node. </td></tr>
    <tr><td class="paramname">load</td><td>Load method. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a class="anchor" id="ad69a5459fad4abfa2a29c2c9e59bd17e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::tuple&lt; aku_Status, LogicAddr &gt; Akumuli::StorageEngine::NBTreeLeaf::commit </td>
          <td>(</td>
          <td class="paramtype">std::shared_ptr&lt; <a class="el" href="classAkumuli_1_1StorageEngine_1_1BlockStore.html">BlockStore</a> &gt;&#160;</td>
          <td class="paramname"><em>bstore</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Flush all pending changes to block store and close. Calling this function too often can result in unoptimal space usage. </p>

</div>
</div>
<a class="anchor" id="a40701c4015765a5c0c7bfeedcda4badd"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">aku_Status Akumuli::StorageEngine::NBTreeLeaf::read_all </td>
          <td>(</td>
          <td class="paramtype">std::vector&lt; aku_Timestamp &gt; *&#160;</td>
          <td class="paramname"><em>timestamps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; double &gt; *&#160;</td>
          <td class="paramname"><em>values</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Read all elements from the leaf node. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">timestamps</td><td>Destination for timestamps. </td></tr>
    <tr><td class="paramname">values</td><td>Destination for values. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>status. </dd></dl>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>libakumuli/storage_engine/<a class="el" href="nbtree_8h_source.html">nbtree.h</a></li>
<li>libakumuli/storage_engine/nbtree.cpp</li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Apr 19 2016 18:18:35 for Akumuli by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
